#textdomain wesnoth-tru
[scenario]
    id=23_Lichs_Den
    name= _ "Lich's Den"
    next_scenario=24_Peace
    map_data="{~add-ons/The_Rising_Underworld/maps/malidron.map}"
    turns=-1
    victory_when_enemies_defeated=no
    experience_modifier=75
    {INTRO_AND_SCENARIO_MUSIC into_the_shadows.ogg the_dangerous_symphony.ogg}
    {EXTRA_SCENARIO_MUSIC "weight_of_revenge.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}
    {EXTRA_SCENARIO_MUSIC "the_deep_path.ogg"}
    {EXTRA_SCENARIO_MUSIC "casualties_of_war.ogg"}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}

	# The scenario is hard since you don't have any expendable distraction units;
	# to make it possible to keep everyone alive, it looks like you're underground but
	# secretly there's no chaotic bonus
    [time]
        id=underground
        name= _ "Underground"
        image=misc/time-schedules/schedule-underground.png
        lawful_bonus=0
        red=-60
        green=-45
        blue=-25
    [/time]

    [story]
        [part]
            story= _ "Perhaps it was a miracle, but Weldyn had beaten back and destroyed the strongest legion that Malidron could assemble. Although none of the allied armies were left in good shape, Reginald knew that it was best to strike hard and fast against the Lich, or else it might escape and return stronger than before. So it was that everyone strong enough to march gathered and made tracks for the Estmark Hills."
        [/part]
        [part]
            {JOURNEY_LICHS_DEN}
            show_title=yes
            background=maps/wesnoth.png
        [/part]
    [/story]

    [event]
        name=prestart

        #this block of code keeps you having the right troops, and no others
        {PACK_ALL_UNITS}
        [unstore_unit]
            variable=reginald
            x,y=39,27
        [/unstore_unit]
        {UNPACK_UNITS robyn}
        {UNPACK_UNITS lucidel}
        {UNPACK_UNITS maricus}
        {UNPACK_UNITS xinaqu}
        {UNPACK_UNITS ferok}
        {UNPACK_UNITS paciran}
        {UNPACK_UNITS dulthaus}
        {UNPACK_UNITS kalrath}
        {UNPACK_UNITS eranhiem}
        {UNPACK_UNITS hyrdmar}
        {UNPACK_UNITS volignis}
        {UNPACK_UNITS lombosilvitac_sagadendol}
        {UNPACK_UNITS gepha}
        [while]
            [have_unit]
                search_recall_list=yes
                x,y=recall,recall
                side=1
            [/have_unit]
            [do]
                [recall]
                    side=1
                [/recall]
            [/do]
        [/while]
        [disallow_recruit]
            side=1
            type=Naga Warrior,Naga Sniper,Merman Fighter,Merman Hunter,Mermaid Initiate
        [/disallow_recruit]
    [/event]

    [event]
        name=start
        {TRU_MESSAGE_NARRATOR (_"Completely unopposed, Reginald and his companions arrived at the battle ground Konrad III had died on. The tortured landscape sickened everyone, and memories weighed heavily on Reginald. But at last they walked straight into the castle of Malidron himself.")}
        {TRU_MESSAGE "Ferok" (_"Looks like that cowardly devil already turned tail!")}
        {TRU_MESSAGE "Robyn" (_"Wait, there's an underground passage behind his keep. Do you think he could be down there?")}
        {TRU_MESSAGE "Reginald" (_"Let's check it out. Everyone on the command council follow me--we'll take a quick look, and if there's enough room we'll call for the rest of you to follow.")}
        [message]
            type=General
            message=_"Yes sir. We won't be far behind."
        [/message]
        [move_unit]
            id=Reginald
            to_x,to_y=49,34
        [/move_unit]
        [remove_shroud]
            side=1
            x=54-55,53,56
            y=37-39,39,38
        [/remove_shroud]
        [scroll_to_unit]
            id=Reginald
        [/scroll_to_unit]
        {VARIABLE moved 0}
        [while]
            [variable]
                name=moved
                not_equals=13
            [/variable]
            [do]
                [teleport]
                    [filter]
                        side=1
                        y=25-30
                        [not]
                            type=General
                        [/not]
                        [not]
                            type=Troll
                        [/not]
                    [/filter]
                    clear_shroud=yes
                    animate=no
                    x,y=49,34
                [/teleport]
                {VARIABLE_OP moved add 1}
            [/do]
        [/while]
        {CLEAR_VARIABLE moved}
        [redraw]
        [/redraw]
        {TRU_MESSAGE "Robyn" (_"Look at all the passages! Old moldy Mali could be anywhere!")}
        {TRU_MESSAGE_RIGHT "Reginald" (_"General, start sending--")}
        {THUNDER (
            [terrain]
                x=45,46
                y=29,29
                terrain=Qxua^Xo
            [/terrain]
            [place_shroud]
                side=1
                x=31-42
                y=20-35
            [/place_shroud]
            [place_shroud]
                side=1
                x=43-45
                y=21-25
            [/place_shroud]
            [redraw]
            [/redraw]
            {GENERIC_UNIT 2 "Wraith" 46 34}
            {GENERIC_UNIT 2 "Wraith" 51 32}
            {GENERIC_UNIT 2 "Skeleton Sorcerer" 50 31}
            {GENERIC_UNIT 2 "Skeleton Sorcerer" 46 33}
            {GENERIC_UNIT 2 "Bone Shooter" 49 31}
            {GENERIC_UNIT 2 "Bone Shooter" 46 32}
            {GENERIC_UNIT 2 "Revenant" 46 31}
            {GENERIC_UNIT 2 "Revenant" 48 30}
            {GENERIC_UNIT 2 "Draug" 50 36}
            {GENERIC_UNIT 2 "Draug" 51 36}
            {GENERIC_UNIT 2 "Lich" 49 37}
            {GENERIC_UNIT 2 "Banebow" 52 35}
        )}
        [kill]
            side=1
            y=0-29
            animate=no
        [/kill]
        [message]
            speaker=narrator
            caption=_"Distant Laughter"
            image=portraits/undead/brown-lich.png~FL()~RIGHT()
            message=_"HA HA HA HA HA HA HA HAAAAAA!!!!"
        [/message]
        {TRU_MESSAGE "Paciran" (_"Look, the entrance is blocked!")}
        {TRU_MESSAGE "Dulthaus" (_"No matter! There're enough o' us to fight off these fellows. Let's get to it!")}
        [modify_unit]
            [filter]
                side=1
                [not]
                    #exclude Kalrath; he already was fearless
                    race=drake
                [/not]
            [/filter]
            {TRAIT_FEARLESS}
        [/modify_unit]
    [/event]

    [event]
        name=prestart

        [objectives]
            side=1
            [objective]
                description= _ "Destroy all immediate threats"
                condition=win
            [/objective]
            {LOSE_DEATH_OBJECTIVE (_"any unit")}
            {NO_GOLD_CARRYOVER_TRU}
            [note]
                description=_"This is the last playable scenario in this campaign"
            [/note]
        [/objectives]

        # This variable keeps track of how many orbs you've recovered:
        {VARIABLE orbs 0}

        [remove_shroud]
            side=1
            x=32-42
            y=21-30
        [/remove_shroud]

        {SCATTER_EMBELLISHMENTS "Uu,Ur" ^Edb 10}
        [item]
            x,y=58,40
            image=dwarven-doors-closed-nomountian.png
        [/item]
        [item]
            x,y=99,4
            image=dwarven-doors-closed-nomountian.png
        [/item]

        {GENERIC_UNIT 1 "General" 35 25}
        {GENERIC_UNIT 1 "Shock Trooper" 35 24}
        {GENERIC_UNIT 1 "Elvish Sorceress" 34 24}
        {GENERIC_UNIT 1 "Troll" 33 25}
        {GENERIC_UNIT 1 "Mermaid Priestess" 32 23}
        {GENERIC_UNIT 1 "Swordsman" 33 22}
        {GENERIC_UNIT 1 "Goblin Pillager" 33 24}
        {GENERIC_UNIT 1 "Dwarvish Steelclad" 36 23}
        {GENERIC_UNIT 1 "Inferno Drake" 32 22}

        {GENERIC_UNIT 3 "Skeletal Dragon" 51 48}{GUARDIAN}
        {GENERIC_UNIT 3 "Ancient Lich" 50 48}{GUARDIAN}
        {GENERIC_UNIT 3 "Draug" 49 48}{GUARDIAN}
        {GENERIC_UNIT 3 "Banebow" 51 47}{GUARDIAN}
        {GENERIC_UNIT 3 "Ghast" 52 47}{GUARDIAN}

        {GENERIC_UNIT 2 "Giant Mudcrawler" 84 13}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Mudcrawler" 85 13}{GUARDIAN}
        {GENERIC_UNIT 2 "Mudcrawler" 84 14}{GUARDIAN}
        {GENERIC_UNIT 2 "Mudcrawler" 85 12}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Spider" 81 13}{GUARDIAN}
        {GENERIC_UNIT 7 "Bone Shooter" 81 20}{GUARDIAN}
        {GENERIC_UNIT 7 "Deathblade" 84 6}{GUARDIAN}
        {GENERIC_UNIT 7 "Necrophage" 98 5}{GUARDIAN}
        {GENERIC_UNIT 7 "Skeleton Sorcerer" 103 6}{GUARDIAN}
        {GENERIC_UNIT 7 "Shadow" 106 2}{GUARDIAN}
        {GENERIC_UNIT 2 "Blood Bat" 115 11}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 94 8}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 95 11}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 98 10}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 99 10}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 100 10}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 101 11}{GUARDIAN}{VARIANT bat}
        {GENERIC_UNIT 7 "Walking Corpse" 101 12}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 99 8}{GUARDIAN}{VARIANT goblin}
        {GENERIC_UNIT 7 "Walking Corpse" 100 4}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 105 15}{GUARDIAN}{VARIANT troll}
        {GENERIC_UNIT 7 "Walking Corpse" 107 10}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 109 8}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 111 13}{GUARDIAN}{VARIANT dwarf}
        {GENERIC_UNIT 7 "Walking Corpse" 118 10}{GUARDIAN}
        {GENERIC_UNIT 7 "Walking Corpse" 95 14}{GUARDIAN}{VARIANT bat}
        {GENERIC_UNIT 7 "Revenant" 117 18}{GUARDIAN}
        {GENERIC_UNIT 7 "Skeleton Sorcerer" 117 21}{GUARDIAN}
        {GENERIC_UNIT 2 "Blood Bat" 112 21}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Mudcrawler" 110 26}{GUARDIAN}
        {GENERIC_UNIT 2 "Mudcrawler" 110 27}{GUARDIAN}
        {GENERIC_UNIT 2 "Mudcrawler" 109 27}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Ant" 108 16}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Ant" 108 17}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Ant" 108 18}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Spider" 98 16}{GUARDIAN}
        {GENERIC_UNIT 7 "Revenant" 82 21}{STUCK}
        {GENERIC_UNIT 7 "Revenant" 83 23}{STUCK}
        {GENERIC_UNIT 7 "Skeleton" 93 18}{STUCK}
        {GENERIC_UNIT 7 "Skeleton" 92 19}{STUCK}
        {GENERIC_UNIT 7 "Skeleton" 99 21}{STUCK}
        {GENERIC_UNIT 7 "Skeleton" 98 22}{STUCK}
        {GENERIC_UNIT 7 "Skeleton" 96 35}{STUCK}
        {GENERIC_UNIT 7 "Skeleton Archer" 97 20}{GUARDIAN}
        {GENERIC_UNIT 7 "Skeleton Archer" 94 20}{GUARDIAN}
        {GENERIC_UNIT 7 "Skeleton Mage" 95 19}{GUARDIAN}
        {GENERIC_UNIT 7 "Skeleton Mage" 96 21}{GUARDIAN}
        {GENERIC_UNIT 7 "Bone Shooter" 88 26}{GUARDIAN}
        {GENERIC_UNIT 7 "Deathblade" 106 36}{GUARDIAN}
        {GENERIC_UNIT 7 "Ghoul" 91 26}{GUARDIAN}
        {GENERIC_UNIT 7 "Bone Shooter" 96 25}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Rat" 89 31}{GUARDIAN}
        {GENERIC_UNIT 2 "Giant Rat" 90 31}{GUARDIAN}
        {GENERIC_UNIT 7 "Ghost" 115 32}{GUARDIAN}
        {GENERIC_UNIT 7 "Ghost" 116 32}{GUARDIAN}
        {GENERIC_UNIT 7 "Ghost" 115 33}{GUARDIAN}

        {GENERIC_UNIT 8 "Ciner Spirit" 52 28}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 51 25}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 48 22}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 50 16}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 52 12}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 52 11}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 53 11}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 54 10}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 56 10}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 57 10}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 62 9}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 68 11}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 69 12}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 71 13}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 71 18}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 70 20}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 66 22}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 64 26}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 61 23}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 55 22}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 63 17}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 71 8}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 73 6}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 78 8}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 78 10}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 77 12}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 44 12}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 43 10}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 45 7}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 49 5}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 52 4}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 41 9}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 42 5}{GUARDIAN}
        {GENERIC_UNIT 8 "Ciner Spirit" 49 3}{GUARDIAN}
        {GENERIC_UNIT 8 "Skeleton Sorcerer" 69 16}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 68 15}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 67 15}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 66 14}{STUCK}
        {GENERIC_UNIT 8 "Skeleton Sorcerer" 65 14}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 64 13}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 63 13}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 63 12}{STUCK}
        {GENERIC_UNIT 8 "Skeleton Sorcerer" 63 11}{STUCK}
        {GENERIC_UNIT 8 "Lich" 51 15}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 52 15}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 53 15}{STUCK}
        {GENERIC_UNIT 8 "Draug" 54 15}{STUCK}
        {GENERIC_UNIT 8 "Skeleton Sorcerer" 55 15}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 56 14}{STUCK}
        {GENERIC_UNIT 8 "Skeleton Sorcerer" 57 14}{STUCK}
        {GENERIC_UNIT 8 "Draug" 58 13}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 58  12}{STUCK}
        {GENERIC_UNIT 8 "Lich" 58 11}{STUCK}
        {GENERIC_UNIT 8 "Draug" 49 14}{STUCK}
        {GENERIC_UNIT 8 "Lich" 49 13}{STUCK}
        {GENERIC_UNIT 8 "Banebow" 49 11}{STUCK}
        {GENERIC_UNIT 8 "Death Knight" 49 10}{STUCK}
        {GENERIC_UNIT 8 "Banebow" 50 9}{STUCK}
        {GENERIC_UNIT 8 "Draug" 53 8}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 54 7}{STUCK}
        {GENERIC_UNIT 8 "Lich" 56 7}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 47 14}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 47 12}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 47 9}{STUCK}
        {GENERIC_UNIT 8 "Bone Shooter" 54 6}{STUCK}
        {GENERIC_UNIT 8 "Deathblade" 56 5}{STUCK}

        {GENERIC_UNIT 2 "Deathblade" 11 21}{GUARDIAN}
        {GENERIC_UNIT 2 "Deathblade" 18 25}{GUARDIAN}
        {GENERIC_UNIT 2 "Deathblade" 11 30}{GUARDIAN}
        {GENERIC_UNIT 2 "Deathblade" 22 33}{GUARDIAN}
    [/event]

    ########################################SET-UP ENDS########################################
    ########################################SET-UP ENDS########################################

    [side]
        save_id=Free Peoples
        gold=500
        income=-2
        no_leader=yes
        side=1
        controller=human
        team_name=humans
        user_team_name=_"Free Peoples"
        color=purple
        {FLAG_VARIANT loyalist}
        shroud=yes
        # Custom death events still result in defeat, this is just important for a couple events in which you briefly have no units:
        defeat_condition=never
    [/side]
    {STARTING_VILLAGES_AREA 1 49 34 1}

    [side]
        side=2
        type=Malidron Lich
        id=Malidron
        name=_"Malidron"
        team_name=undead
        user_team_name=_"Undead"
        gold=1000
        income=25
        color=green
        {FLAG_VARIANT undead}
        [ai]
            aggression=1
        [/ai]
    [/side]

    [side]
        side=3
        no_leader=yes
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=15
        color=brown
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            aggression=.6
        [/ai]
    [/side]

    [side]
        side=4
        type=Spectre
        id=glac_gen
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-5
        recruit=Wraith,Shadow,Ghost
        color=white
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            aggression=.7
        [/ai]
    [/side]
    {STARTING_VILLAGES 4 6}
    {STARTING_VILLAGES_AREA 4 78 40 0}
    {STARTING_VILLAGES_AREA 4 63 35 0}

    [side]
        side=5
        type=Lich
        id=thal_gen_one
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-6
        recruit=Thal Spirit, Soulless
        color=blue
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            # Make sure he doesn't send anyone out of the ocean to where they'll be ridiculously vulnerable:
            [goal]
                [criteria]
                    side=1
                    [filter_location]
                        terrain=W*^*,*w
                    [/filter_location]
                [/criteria]
                value=5
            [/goal]
            aggression=.7
            recruitment_pattern=fighter,archer
            caution=.1
        [/ai]
    [/side]
    {RECRUIT_UNIT_VARIATIONS 5 "Soulless" swimmer}
    {STARTING_VILLAGES 5 16}

    [side]
        side=6
        type=Mariners Nightmare
        id=thal_gen_two
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-3
        recruit=Undead Cuttle Fish,Mariners Nightmare
        color=blue
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            recruitment_pattern=mixed fighter,fighter
            village_value=0
        [/ai]
    [/side]
    {STARTING_VILLAGES_AREA 6 10 27 0}

    [side]
        side=7
        type=Death Knight
        id=umber_gen
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-2
        # This basically means he has no unit upkeep, so his income is constant regardless of how many of his troops you've killed:
        village_support=10000
        village_gold=0
        recruit=Walking Corpse
        color=black
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        scroll_to_leader=no
        [ai]
            aggression=1
        [/ai]
    [/side]
    {RECRUIT_UNIT_VARIATIONS 7 "Walking Corpse" dwarf,dwarf,dwarf,goblin,goblin,mounted,saurian,troll,troll,bat,bat,none,none,none,none,none,none,none,none,none}
    {STARTING_VILLAGES 7 3}
    {STARTING_VILLAGES_AREA 7 118 19 3}

    [side]
        side=8
        type=Death Knight
        id=ciner_gen
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-2
        village_support=10000
        village_gold=0
        recruit=Necrophage,Skeleton Sorcerer,Deathblade,Bone Shooter
        color=orange
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            aggression=1
        [/ai]
    [/side]
    {STARTING_VILLAGES 8 8}
    {STARTING_VILLAGES_AREA 8 52 9 8}
    {STARTING_VILLAGES_AREA 8 75 9 2}

    [side]
        side=9
        type=Lich
        id=zeph_gen
        team_name=undead
        user_team_name=_"Undead"
        gold=0
        income=-5
        recruit=Skeleton,Skeleton Archer,Ghost,Ghoul,Skeleton Mage
        color=orange
        {FLAG_VARIANT undead}
        scroll_to_leader=no
        [ai]
            # Make sure he doesn't send anyone down the windy passage:
            [avoid]
                x=59
                y=44-49
            [/avoid]
            [avoid]
                x=56,57,58
                y=42,43,43
            [/avoid]
            aggression=.9
        [/ai]
    [/side]
    {STARTING_VILLAGES 9 11}
    {STARTING_VILLAGES_AREA 9 58 52 0}

    # A little help:
    {OBJ_POTION_HOLY 52 37 holy1}
    {OBJ_POTION_HOLY 53 37 holy2}

    # A little more help:
    {PICKUPPABLE_ITEM armor_1 50 36 (
        side=1
        [not]
            race=monster,dwarf,drake
        [/not]
    ) items/armor.png
    _"$unit.name found a suit of armor. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a suit of armor, but can only fit someone with a human-like shape." (
        [object]
            name= _ "Suit of Armor"
            image=items/armor.png
            description= _ "This armor increases damage resistances!"
            [effect]
                apply_to=resistance
                replace=yes
                [resistance]
                    blade=70
                    pierce=70
                    impact=70
                [/resistance]
            [/effect]
            [effect]
                apply_to=resistances
                [resistance]
                    cold=-10
                    arcane=-10
                [/resistance]
            [/effect]
        [/object]
    )}
    {PICKUPPABLE_ITEM armor_2 51 36 (
        side=1
        [not]
            race=monster,dwarf,drake
        [/not]
    ) items/armor.png
    _"$unit.name found a suit of armor. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a suit of armor, but can only fit someone with a human-like shape." (
        [object]
            name= _ "Suit of Armor"
            image=items/armor.png
            description= _ "This armor increases the wearer's damage resistances!"
            [effect]
                apply_to=resistance
                replace=yes
                [resistance]
                    blade=70
                    pierce=70
                    impact=70
                [/resistance]
            [/effect]
            [effect]
                apply_to=resistances
                [resistance]
                    cold=-10
                    arcane=-10
                [/resistance]
            [/effect]
        [/object]
    )}

    # As soon as you clear out the entrance hall
    [event]
        name=die
        [filter_condition]
            [have_unit]
                side=2
                [filter_location]
                    [filter]
                        side=1
                    [/filter]
                    radius=4
                [/filter_location]
                count=0
            [/have_unit]
        [/filter_condition]
        {TRU_MESSAGE "Xinaqu" (_"We should be ssafe for now.")}
        {TRU_MESSAGE "Maricus" (_"But for how long? Our plight is dire; the dead doubtlessly surround us, and have little hope for escape.")}
        {TRU_MESSAGE "Reginald" (_"True, but Malidron is in here somewhere. If I had to guess, I'd say he's down the passage that's magically blocked the same way as our exit route. But wherever he is, we'd better start exploring this place.")}
        {TRU_MESSAGE "Dulthaus" (_"Very true! And I'm itching to see more of the cave due East. That's good earth; besides, it looks like it will take a long time to map out. We should get started down there right away.")}
        {TRU_MESSAGE "Lucidel" (_"Just be careful! We may have to split up to explore everywhere, but if we split up too much we will be too vulnerable.")}
        [objectives]
            side=1
            [objective]
                description= _ "Find Malidron"
                condition=win
            [/objective]
            {LOSE_DEATH_OBJECTIVE (_"any unit")}
            {NO_GOLD_CARRYOVER_TRU}
            [note]
                description=_"This is the last playable scenario in this campaign"
            [/note]
        [/objectives]
        [show_objectives]
        [/show_objectives]

        # Potentially very useful instant-heal tree:
        [event]
            name=new turn
            [animate_unit]
                flag=healing
                [filter]
                    id=Lombosilvitac_Sagadendol
                [/filter]
                [facing]
                    x,y=48,32
                [/facing]
            [/animate_unit]
            [sound]
                name=heal.wav
            [/sound]
            {HIGHLIGHT_IMAGE 48 32 scenery/oak-leaning.png ()}
            [delay]
                time=300
            [/delay]
            [remove_item]
                x,y=48,32
            [/remove_item]
            [delay]
                time=300
            [/delay]
            [animate_unit]
                flag=healing
                [filter]
                    id=Lombosilvitac_Sagadendol
                [/filter]
                [facing]
                    x,y=48,32
                [/facing]
            [/animate_unit]
            [sound]
                name=heal.wav
            [/sound]
            {HIGHLIGHT_IMAGE 48 32 scenery/oak-leaning.png ()}
            {TRU_MESSAGE "Paciran" (_"Lombosilvitac-Sagadendol! You do us a great honor!")}
            {TRU_MESSAGE "Lucidel" (_"Well, if that isn't a Cura Tree! They existed only in legends. If it's fresh from the tree, one bite of its fruit will heal any wound!")}
            [message]
                speaker=narrator
                image="scenery/oak-leaning.png"
                message=_"Move any unit onto this tree to instantly heal it!"
            [/message]
            [event]
                name=moveto
                [filter]
                    x,y=48,32
                [/filter]
                first_time_only=no
                [store_unit]
                    [filter]
                        x,y=48,32
                    [/filter]
                    variable=heal
                [/store_unit]
                [if]
                    [variable]
                        name=heal.side
                        equals=1
                    [/variable]
                    [then]
                        [heal_unit]
                            [filter]
                                x,y=48,32
                            [/filter]
                            animate=yes
                        [/heal_unit]
                    [/then]
                [/if]
            [/event]
        [/event]
    [/event]

    # The windy passage:
    [event]
        name=moveto
        first_time_only=no
        [filter]
            [filter_location]
                terrain=Hhd^Es
            [/filter_location]
        [/filter]
        [sound]
            name=magic-faeriefire-miss.ogg
        [/sound]
        [move_unit]
            x,y=$x1|,$y1
            to_x,to_y=48,37
            fire_event=no
        [/move_unit]
        [if]
            [variable]
                name=wind_happened
                not_equals=yes
            [/variable]
            [then]
                {VARIABLE wind_happened yes}
                {TRU_MESSAGE "Dulthaus" (_"That'll be work of that wind demon! The wind in that tunnel is too strong for any o' us to make it through.")}
            [/then]
        [/if]
    [/event]

    # Constant reinforcements in Ciner's area:
#define CINER_REENFORCEMENT TERRAIN COUNT
    [if]
        [have_unit]
            [filter_location]
                terrain={TERRAIN}
            [/filter_location]
            count={COUNT}
        [/have_unit]
        [else]
            {RANDOM 1..4}
            [switch]
                variable=random
                [case]
                    value=1
                    {VARIABLE unit "Revenant"}
                [/case]
                [case]
                    value=2
                    {VARIABLE unit "Deathblade"}
                [/case]
                [case]
                    value=3
                    {VARIABLE unit "Bone Shooter"}
                [/case]
                [case]
                    value=4
                    {VARIABLE unit "Skeleton Sorcerer"}
                [/case]
            [/switch]
            [store_locations]
                variable=castles
                terrain={TERRAIN}
            [/store_locations]
            [while]
                [variable]
                    name=castles.length
                    greater_than=0
                [/variable]
                [variable]
                    name=break
                    not_equals=yes
                [/variable]
                [do]
                    [if]
                        [have_unit]
                            x,y=$castles[0].x|,$castles[0].y|
                        [/have_unit]
                        [then]
                            {CLEAR_VARIABLE castles[0]}
                        [/then]
                        [else]
                            {GENERIC_UNIT 8 $unit recall recall}{STUCK}
                            [recall]
                                side=8
                                x,y=$castles[0].x|,$castles[0].y|
                                show=yes
                            [/recall]
                            {VARIABLE break yes}
                        [/else]
                    [/if]
                [/do]
            [/while]
            {CLEAR_VARIABLE break,castles}
        [/else]
    [/if]
    {CLEAR_VARIABLE random,unit}
#enddef
    [event]
        name=side 9 turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=orbs
                not_equals=6
            [/variable]
        [/filter_condition]
        {CINER_REENFORCEMENT Cud^Es 10}
        {CINER_REENFORCEMENT Cud^Edt 9}
    [/event]

    
    # Activate Ciner's troops when you arrive
    [event]
        name=attack end
        [filter]
            type="Ciner Spirit"
            [or]
                [filter_adjacent]
                    type="Ciner Spirit"
                [/filter_adjacent]
            [/or]
        [/filter]
        [gold]
            side=8
            amount=250
        [/gold]
    [/event]
    # A ring that lets someone walk on lava:
    {PICKUPPABLE_ITEM ring_lava 75 9 (
        side=1
        [not]
            id=Kalrath
        [/not]
        [not]
            id=Volignis
        [/not]
    ) items/ring-red.png
    _"$unit.name found a ring. It glows red like the lava that surrounds it, but cannot be worn by a drake or dragon. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring. It glows red like the lava that surrounds it, but cannot be worn by a drake or dragon." (
        [object]
            name= _ "Ring of Lava"
            image=items/ring-red.png
            description= _ "This ring allows the wearer to walk unharmed on lava!"
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    unwalkable=1
                [/movement_costs]
            [/effect]
            [effect]
                apply_to=defense
                replace=yes
                [defense]
                    unwalkable=70
                [/defense]
            [/effect]
        [/object]
    )}

    # Door to Umber's general
    [event]
        name=moveto
        [filter]
            side=1
            x,y=99,4
        [/filter]
        #wmllint: local spellings Tryan
        {TRU_MESSAGE "Gepha" (_"Looks like that door's locked. Tryan' to keep us out aye? We'll see about that...")}
        {EARTHQUAKE (
            [terrain]
                x,y=98,3
                terrain=Uu
            [/terrain]
        )}
        [remove_item]
            x,y=98,3
        [/remove_item]
        [gold]
            side=7
            amount=225
        [/gold]
    [/event]

    # The four rings of speed:
    {PICKUPPABLE_ITEM ring1 83 6 side=1 items/ring-gold.png
    _"$unit.name found a ring. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring, but can't fit it onto his finger." (
        [object]
            name= _ "Ring of Speed"
            image=items/ring-gold.png
            description= _ "This ring grants the wearer +1 movement!"
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}
    {PICKUPPABLE_ITEM ring2 103 5 side=1 items/ring-gold.png
    _"$unit.name found a ring. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring, but can't fit it onto his finger." (
        [object]
            name= _ "Ring of Speed"
            image=items/ring-gold.png
            description= _ "This ring grants the wearer +1 movement!"
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}
    {PICKUPPABLE_ITEM ring3 87 26 side=1 items/ring-gold.png
    _"$unit.name found a ring. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring, but can't fit it onto his finger." (
        [object]
            name= _ "Ring of Speed"
            image=items/ring-gold.png
            description= _ "This ring grants the wearer +1 movement!"
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}
    {PICKUPPABLE_ITEM ring4 107 36 side=1 items/ring-gold.png
    _"$unit.name found a ring. Should he pick it up?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring, but can't fit it onto his finger." (
        [object]
            name= _ "Ring of Speed"
            image=items/ring-gold.png
            description= _ "This ring grants the wearer +1 movement!"
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}

    # Ring granting full movement in cave
    {PICKUPPABLE_ITEM ring_cave 62 31 (
        side=1
        [not]
            race=dwarf
        [/not]
    )
    items/ring-brown.png
    _"$unit.name found a ring hidden in some loose dirt. It looks as earthy as the cave it laid in, but cannot be worn by a dwarf. Should he take it?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring hidden in some loose dirt. It looks as earthy as the cave it laid in, but cannot be worn by a dwarf." (
        [object]
            name= _ "Ring of Earth"
            image=items/ring-brown.png
            description= _ "This ring allows the wearer to move quickly through cave!"
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    cave=1
                [/movement_costs]
            [/effect]
        [/object]
    )}

    # A warning about the long, cave-y passage:
    [event]
        name=moveto
        [filter]
            side=1
            x=64-1000
            [filter_location]
                terrain=Uu
            [/filter_location]
        [/filter]
        {TRU_MESSAGE "Dulthaus" (_"It looks as though this tunnel'll be long indeed! Anyone unaccustomed to caves better not plan on going through.")}
    [/event]

    # Activate Glac's troops when you get near
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                terrain=Ha,Aa,Rb,Ms,Aa^Vaa,Cha
            [/filter_location]
            [and]
                x=69-1000
                [or]
                    y=0-34
                [/or]
            [/and]
        [/filter]
        {THUNDER ()}
        {TRU_MESSAGE "Eranhiem" (_"Be careful!")}
        [gold]
            side=4
            amount=350
        [/gold]
        {GENERIC_UNIT 4 "Ghost" 61 39}
        {GENERIC_UNIT 4 "Wraith" 67 43}
        {GENERIC_UNIT 4 "Wraith" 65 32}
    [/event]

    # Sicc's troops are very cautious until the battle starts, to prevent them from being picked off one at a time
    [event]
        name=attack end
        [filter]
            side=3
            [or]
                [filter_adjacent]
                    side=3
                [/filter_adjacent]
            [/or]
        [/filter]
        [store_unit]
            [filter]
                side=3
            [/filter]
            variable=side_three
        [/store_unit]
        [while]
            [variable]
                name=side_three.length
                greater_than=0
            [/variable]
            [do]
				# Just recreate the units without the {GUARDIAN} special:
                {GENERIC_UNIT 3 $side_three[0].type $side_three[0].x $side_three[0].y}
                [+unit]
                    hitpoints=$side_three[0].hitpoints
                    experience=$side_three[0].experience
                    moves=$side_three[0].moves
                    attacks_left=$side_three[0].attacks_left
                    facing=$side_three[0].facing
                    to_variable=unit
                [/unit]
                [unstore_unit]
                    variable=unit
                [/unstore_unit]
                {CLEAR_VARIABLE unit,side_three[0]}
            [/do]
        [/while]
    [/event]
    #Sicc's area should be slightly lit
    [event]
        name=prestart
        [modify_unit]
            [filter]
                x,y=51,48
            [/filter]
            moves=12
        [/modify_unit]
        [store_reachable_locations]
            [filter]
                x,y=51,48
            [/filter]
            variable=sicc_locs
        [/store_reachable_locations]
        [time_area]
            find_in=sicc_locs
            {SHALLOW_UNDERGROUND}
        [/time_area]
        {CLEAR_VARIABLE sicc_locs}
        [modify_unit]
            [filter]
                x,y=51,48
            [/filter]
            moves=5
        [/modify_unit]
    [/event]

    # Make all the water portals in Thal's area:
#define BIDIRECTIONAL_TELEPORT X1 Y1 X2 Y2 IMAGE
    [event]
        name=prestart
        [item]
            x,y={X1},{Y1}
            image={IMAGE}
        [/item]
        [item]
            x,y={X2},{Y2}
            image={IMAGE}
        [/item]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y={X1},{Y1}
        [/filter]
        [teleport]
            [filter]
                x,y={X1},{Y1}
            [/filter]
            x,y={X2},{Y2}
            animate=yes
            clear_shroud=yes
        [/teleport]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y={X2},{Y2}
        [/filter]
        [teleport]
            [filter]
                x,y={X2},{Y2}
            [/filter]
            x,y={X1},{Y1}
            animate=yes
            clear_shroud=yes
        [/teleport]
    [/event]
#enddef
    {BIDIRECTIONAL_TELEPORT 28 39 42 55 "scenery/whirlpool.png"}
    {BIDIRECTIONAL_TELEPORT 37 44 12 56 "scenery/whirlpool.png"}
    {BIDIRECTIONAL_TELEPORT 14 42 42 53 "scenery/whirlpool.png"}
    {BIDIRECTIONAL_TELEPORT 10 50 29 49 "scenery/whirlpool.png"}
    {BIDIRECTIONAL_TELEPORT 36 61 19 60 "scenery/whirlpool.png"}
    {BIDIRECTIONAL_TELEPORT 29 62 16 17 "scenery/whirlpool.png"}

    # A ring that helps a unit move in water
    {PICKUPPABLE_ITEM ring_water 20 16 (
        side=1
        [not]
            id=Maricus
        [/not]
        [not]
            id=Xinaqu
        [/not]
        [not]
            id=Hyrdmar
        [/not]
    ) items/ring-silver.png
    _"$unit.name found a ring. It glistens beautifully with the colors of water, but can only be worn by a land-dweller. Should he take it?"
    _"ring of HP^Take it"
    _"ring of HP^Leave it"
    _"$unit.name found a ring. It glistens beautifully with the colors of water, but can only be worn by a land-dweller." (
        [object]
            name= _ "Water Ring"
            image=items/ring-silver.png
            description= _ "This ring grants the wearer excellent movement and defense in water terrains!"
            [effect]
                apply_to=movement_costs
                replace=yes
                [movement_costs]
                    deep_water=1
                    shallow_water=1
                    reef=2
                    swamp_water=1
                [/movement_costs]
            [/effect]
            [effect]
                apply_to=defense
                replace=yes
                [defense]
                    deep_water=60
                    shallow_water=50
                    reef=40
                    swamp_water=50
                [/defense]
            [/effect]
        [/object]
    )}

    # Activate the first of Thal's generals
    [event]
        name=moveto
        [filter]
            side=1
            x=1-38
            y=36-100
        [/filter]
        {TRU_MESSAGE "Hyrdmar" (_"Hsss... There are many water portalsss near usss... Perhapss we can usse them to our advantage.")}
        [gold]
            side=5
            amount=225
        [/gold]
        {VARIABLE hint_turn $turn_number}
        {VARIABLE_OP hint_turn add 12}
        #Schedule a hint in case the player hasn't figured out how to advance in the the water area
        [event]
            name=new turn
            [filter_condition]
                [variable]
                    name=hint_turn
                    equals=$turn_number
                [/variable]
                [variable]
                    name=in_second_thal
                    not_equals=yes
                [/variable]
            [/filter_condition]
            {TRU_MESSAGE "Xinaqu" (_"I wonder if any of thosse water portals lead ssomewhere outsside of the main water chamber?")}
        [/event]
    [/event]

    # Activate the second of Thal's generals
    [event]
        name=moveto
        [filter]
            side=1
            x=1-38
            y=1-30
        [/filter]
        {VARIABLE in_second_thal yes}
        [gold]
            side=6
            amount=300
        [/gold]
    [/event]

    # Make all the main portals:
#define MAIN_TELEPORT X1 Y1 X2 Y2 I1 I2 ID
    [event]
        name=prestart
        [item]
            x,y={X1},{Y1}
            halo={I1}
        [/item]
        [item]
            x,y={X2},{Y2}
            image={I2}
        [/item]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y={X1},{Y1}
        [/filter]
        [teleport]
            [filter]
                x,y={X1},{Y1}
            [/filter]
            x,y={X2},{Y2}
            animate=yes
            clear_shroud=yes
        [/teleport]
        [fire_event]
            name={ID}
        [/fire_event]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y={X2},{Y2}
        [/filter]
        [teleport]
            [filter]
                x,y={X2},{Y2}
            [/filter]
            x,y=49,34
            animate=yes
            clear_shroud=yes
        [/teleport]
    [/event]
#enddef
    [item]
        x,y=49,34
        image=scenery/summoning-center.png
    [/item]
    {MAIN_TELEPORT 53 50 21 17 scenery/rune1-glow.png scenery/rune1.png none}
    {MAIN_TELEPORT 2 24 79 41 scenery/rune2-glow.png scenery/rune2.png none}
    {MAIN_TELEPORT 82 31 119 22 scenery/rune3-glow.png scenery/rune3.png none}
    {MAIN_TELEPORT 119 17 76 8 scenery/rune4-glow.png scenery/rune4.png none}
    {MAIN_TELEPORT 48 6 64 49 scenery/rune5-glow.png scenery/rune5.png start_zeph}
    {MAIN_TELEPORT 80 56 54 49 scenery/rune6-glow.png scenery/rune6.png none}

    #When you first take the portal to Zeph's area:
    [event]
        name=start_zeph
        [gold]
            side=9
            amount=400
        [/gold]
    [/event]

    #When you finish off Sicc's troops:
    [event]
        name=die
        [filter_condition]
            [not]
                [have_unit]
                    side=3
                [/have_unit]
            [/not]
        [/filter_condition]
        [item]
            x,y=$x1|,$y1
            image=items/ball-magenta.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x2|,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    #When you take out Glac's leader:
    [event]
        name=die
        [filter]
            id=glac_gen
        [/filter]
        [kill]
            side=4
            animate=yes
        [/kill]
        [item]
            x,y=$x1|,$y1
            image=items/ball-blue.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x2|,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    #Reward for defeating the second of Thal's leaders:
    [event]
        name=die
        [filter]
            id=thal_gen_two
        [/filter]
        [item]
            x,y=$x1|,$y1
            image=items/ball-blue.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x2|,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    #Once you've hunted down Umber's general:
    [event]
        name=die
        [filter]
            id=umber_gen
        [/filter]
        [item]
            x,y=$x1|,$y1
            image=items/ball-green.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x2|,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    #After getting through Ciner's troops:
    [event]
        name=prestart
        [item]
            x,y=47,7
            image=items/chest.png
        [/item]
    [/event]
    [event]
        name=moveto
        [filter]
            x,y=47,7
        [/filter]
        [remove_item]
            x,y=47,7
        [/remove_item]
        [sound]
            name=open-chest.wav
        [/sound]
        [item]
            x,y=47,7
            image=items/ball-magenta.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x1|,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

    #One the death of Zeph's leader:
    [event]
        name=die
        [filter]
            id=zeph_gen
        [/filter]
        [item]
            x,y=$x1|,$y1
            image=items/ball-green.png
        [/item]
        [fire_event]
            name=got_orb
            [primary_unit]
                x,y=$x2|,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    #Keep track of how many orbs you've collected, and take action once you have all six
    #(also, some dialogue for the first orb you find)
    [event]
        name=got_orb
        first_time_only=no
        {VARIABLE_OP orbs add 1}
        [if]
            [variable]
                name=orbs
                equals=1
            [/variable]
            [then]
                {TRU_MESSAGE "Ferok" (_"Would you look at this thing!")}
                {TRU_MESSAGE "Lucidel" (_"It's a magic orb. It may have some connection to the magic barriers in the entrance hall.")}
                {TRU_MESSAGE "Robyn" (_"Could there be more of them?")}
                {TRU_MESSAGE "Paciran" (_"There could be. One for each element, to venture a guess? Leave it here for now, but we should all keep a close eye out for another.")}
            [/then]
        [/if]
        [if]
            [variable]
                name=orbs
                equals=6
            [/variable]
            [then]
                {TRU_MESSAGE "Lucidel" (_"Ah! Now we have one orb from each of the elements' chambers... and I feel something happening. It would seem that Paciran's guess wasn't far amiss.")}
                [scroll_to]
                    x,y=54,38
                [/scroll_to]
                [remove_shroud]
                    side=1
                    x=54-60
                    y=37-42
                [/remove_shroud]
                [redraw]
                [/redraw]
                {MAP_FRAME Urb 53 38}
                {MAP_FRAME Urb 54 37}
                {MAP_FRAME Urb 54 38}
                {MAP_FRAME Urb 55 38}
                {TRU_MESSAGE "Reginald" (_"Well, our exit is still blocked, but Malidron can't be far away now. Everyone group together; we'll rest a little, and then press on.")}
                [heal_unit]
                    [filter]
                        side=1
                    [/filter]
                    amount=full
                    animate=no
                    moves=full
                    restore_attacks=yes
                    restore_statuses=yes
                [/heal_unit]
                {PACK_ALL_UNITS}
                [kill]
                    [not]
                        id=Malidron
                    [/not]
                [/kill]
                [unstore_unit]
                    variable=reginald
                    x,y=87,53
                [/unstore_unit]
                [unstore_unit]
                    variable=robyn
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=lucidel
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=maricus
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=xinaqu
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=ferok
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=paciran
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=dulthaus
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=kalrath
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=eranhiem
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=hyrdmar
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=volignis
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=lombosilvitac_sagadendol
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [unstore_unit]
                    variable=gepha
                    x,y=87,53
                    find_vacant=yes
                [/unstore_unit]
                [remove_shroud]
                    side=1
                    terrain=Urb^*,Ur^*,Cud,Xos,Xol,Xu
                    [and]
                        x,y=95,48
                        radius=14
                    [/and]
                    [not]
                        y=0-41
                    [/not]
                [/remove_shroud]
                [redraw]
                [/redraw]
                [scroll_to_unit]
                    id=Reginald
                [/scroll_to_unit]
                {TRU_MESSAGE_NARRATOR (_"The heroes did just that. Once everyone felt ready, they pushed open the heavy doors and found themselves in a long hallway, closed on the end by a solid iron gate.")}
                [objectives]
                    side=1
                    [objective]
                        description= _ "Survive and find a way to open the iron gate."
                        condition=win
                    [/objective]
                    {LOSE_DEATH_OBJECTIVE (_"any unit")}
                    {NO_GOLD_CARRYOVER_TRU}
                    [note]
                        description=_"This is the last playable scenario in this campaign"
                    [/note]
                [/objectives]
                [show_objectives]
                [/show_objectives]
                [event]
                    name=side 3 turn refresh
                    {THUNDER ()}
                    [delay]
                        time=200
                    [/delay]
                    {FLASH_WHITE ()}
                    {FADE_TO_BLACK_HOLD 500}
                    [replace_map]
                        map="{~add-ons/The_Rising_Underworld/maps/malidron2.map}"
                    [/replace_map]
                    {FADE_IN}
                    [delay]
                        time=400
                    [/delay]
                    {THUNDER (
                        {UNIT 3 "Lich" 107 48 moves=0}
                        {UNIT 3 "Draug" 106 47 moves=0}
                        {UNIT 3 "Draug" 106 48 moves=0}
                        {UNIT 4 "Spectre" 85 48 canrecruit=yes}
                        {UNIT 5 "Mariners Nightmare" 102 52 canrecruit=yes}
                        {UNIT 7 "Revenant" 89 45 canrecruit=yes}
                        {UNIT 8 "Death Knight" 95 42 canrecruit=yes}
                        {UNIT 9 "Lich" 94 55 canrecruit=yes}
                        [redraw]
                        [/redraw]
                    )}
                    [music]
                        name="northern_mountains.ogg"
                        append=yes
                        immediate=yes
                    [/music]
                    [delay]
                        time=500
                    [/delay]
                    [modify_side]
                        side=4
                        gold=220
                        income=-2
                        [ai]
                            aggression=.9
                            passive_leader=yes
                        [/ai]
                    [/modify_side]
                    [modify_side]
                        side=5
                        gold=150
                        income=-2
                        [ai]
                            aggression=.9
                            passive_leader=yes
                        [/ai]
                    [/modify_side]
                    [modify_side]
                        side=7
                        gold=150
                        income=-2
                        [ai]
                            aggression=.9
                            passive_leader=yes
                        [/ai]
                    [/modify_side]
                    [modify_side]
                        side=8
                        gold=200
                        income=-2
                        recruit=Ciner Spirit
                        [ai]
                            aggression=.9
                            passive_leader=yes
                        [/ai]
                    [/modify_side]
                    [modify_side]
                        side=9
                        gold=160
                        income=-2
                        [ai]
                            aggression=.9
                            passive_leader=yes
                        [/ai]
                    [/modify_side]
                    [fire_event]
                        name=final_battle
                    [/fire_event]
                [/event]
            [/then]
        [/if]
    [/event]

    #This just signals that the final battle has begun, so child events can take effect when the battle is over
    [event]
        name=final_battle
        #When the battle is over:
        [event]
            name=die
            [filter_condition]
                [have_unit]
                    [not]
                        side=1
                        [or]
                            side=2
                        [/or]
                    [/not]
                    count=0
                [/have_unit]
            [/filter_condition]
            {TRU_MESSAGE "Reginald" (_"Malidron! We survived everything you have! Now open your gate and face us, once and for all!")}
            [delay]
                time=500
            [/delay]
            [scroll_to]
                terrain=Urb^Xo
            [/scroll_to]
            [terrain]
                [and]
                    terrain=Urb^Xo
                [/and]
                terrain=Urb
            [/terrain]
            #Reveal Malidron so there isn't any chance of an "Enemy unit sighted" message after the scenario ends
            [remove_shroud]
                side=1
                x,y=108,42
            [/remove_shroud]
            #We end the event so the terrain animation of the gate opening can play: it's triggered by the terrain change. We pick back up after the player makes a move.
            [event]
                name=moveto
                [filter]
                    side=1
                [/filter]
                [move_unit]
                    side=1
                    x=107-109
                    y=41-43
                    [not]
                        id=Reginald
                    [/not]
                    to_x,to_y=105,44
                [/move_unit]
                [move_unit]
                    id=Reginald
                    to_x,to_y=107,43
                [/move_unit]
                [remove_shroud]
                    side=1
                    x=101-116
                    y=37-46
                [/remove_shroud]
                [redraw]
                [/redraw]
                [scroll_to]
                    x,y=110,41
                [/scroll_to]
                [delay]
                    time=500
                [/delay]
                {TRU_MESSAGE "Reginald" (_"You piece of filth. There finally is nothing for you to hide behind!")}
                [move_unit]
                    id=Robyn
                    to_x,to_y=106,43
                [/move_unit]
                {TRU_MESSAGE "Robyn" (_"WAIT! REG!!!!!!!")}
                [move_unit]
                    id=Reginald
                    to_x,to_y=107,42
                [/move_unit]
                [music]
                    name=silence.ogg
                    immediate=yes
                    append=no
                [/music]
                [move_unit]
                    id=Robyn
                    to_x,to_y=107,43
                [/move_unit]
                [animate_unit]
                    flag=attack
                    hits=yes
                    [filter]
                        id=Malidron
                    [/filter]
                    [primary_attack]
                        name=chill tempest
                    [/primary_attack]
                    [facing]
                        [filter]
                            id=Robyn
                        [/filter]
                    [/facing]
                    [animate]
                        flag=defend
                        hits=yes
                        [filter]
                            id=Robyn
                        [/filter]
                        [facing]
                            [filter]
                                id=Malidron
                            [/filter]
                        [/facing]
                    [/animate]
                [/animate_unit]
                [kill]
                    id=Robyn
                    animate=yes
                    fire_event=no
                [/kill]
                {TRU_MESSAGE_RIGHT "Malidron" (_"CURSES!!! THAT SPELL WAS MEANT FOR YOU, YOU PATHETIC MORTAL! No matter! Not one of you is capable of destroying me! I'll kill you all, one by one!")}
                {TRU_MESSAGE_NARRATOR (_"For the second time, Reginald's back bent with sorrow. But it lasted only a moment, and his eyes came back up. Anguished, yet cold and hard, was his face as he addressed his companions.")}
                {TRU_MESSAGE "Reginald" (_"It's time.")}
                [move_unit]
                    id=Reginald
                    to_x,to_y=109,42
                [/move_unit]
                [move_unit]
                    id=Lombosilvitac_Sagadendol
                    to_x,to_y=108,41
                [/move_unit]
                [move_unit]
                    id=Gepha
                    to_x,to_y=109,43
                [/move_unit]
                [move_unit]
                    id=Volignis
                    to_x,to_y=107,42
                [/move_unit]
                [move_unit]
                    id=Eranhiem
                    to_x,to_y=108,43
                [/move_unit]
                [move_unit]
                    id=Hyrdmar
                    to_x,to_y=107,43
                [/move_unit]
                [scroll_to]
                    x,y=110,41
                [/scroll_to]
                [lock_view]
                [/lock_view]
                [animate_unit]
                    flag=defend
                    hits=yes
                    [filter]
                        id=Malidron
                    [/filter]
                    [animate]
                        flag=attack
                        hits=yes
                        [primary_attack]
                            name=sword
                        [/primary_attack]
                        [filter]
                            id=Reginald
                        [/filter]
                        [facing]
                            [filter]
                                id=Malidron
                            [/filter]
                        [/facing]
                        [animate]
                            flag=attack
                            hits=yes
                            [primary_attack]
                                name=holy fire
                            [/primary_attack]
                            [filter]
                                id=Lombosilvitac_Sagadendol
                            [/filter]
                            [facing]
                                [filter]
                                    id=Malidron
                                [/filter]
                            [/facing]
                            [animate]
                                flag=attack
                                hits=yes
                                [primary_attack]
                                    name=fire breath
                                [/primary_attack]
                                [filter]
                                    id=Volignis
                                [/filter]
                                [facing]
                                    [filter]
                                        id=Malidron
                                    [/filter]
                                [/facing]
                                [animate]
                                    flag=attack
                                    hits=yes
                                    [primary_attack]
                                        name=Tidal Wave
                                    [/primary_attack]
                                    [filter]
                                        id=Hyrdmar
                                    [/filter]
                                    [facing]
                                        [filter]
                                            id=Malidron
                                        [/filter]
                                    [/facing]
                                    [animate]
                                        flag=attack
                                        hits=yes
                                        [primary_attack]
                                            name=Snow Bath
                                        [/primary_attack]
                                        [filter]
                                            id=Eranhiem
                                        [/filter]
                                        [facing]
                                            [filter]
                                                id=Malidron
                                            [/filter]
                                        [/facing]
                                        [animate]
                                            flag=attack
                                            hits=yes
                                            [primary_attack]
                                                name=hammer
                                            [/primary_attack]
                                            [filter]
                                                id=Gepha
                                            [/filter]
                                            [facing]
                                                [filter]
                                                    id=Malidron
                                                [/filter]
                                            [/facing]
                                        [/animate]
                                    [/animate]
                                [/animate]
                            [/animate]
                        [/animate]
                    [/animate]
                [/animate_unit]
                {PACK_ALL_UNITS}
                {FADE_TO_BLACK}
                [kill]
                    id=Malidron
                    animate=no
                [/kill]
                [sound]
                    name=lich-die-long.ogg
                [/sound]
                [delay]
                    time=1000
                [/delay]
                {FADE_IN}
                [unlock_view]
                [/unlock_view]
                [endlevel]
                    result=victory
                    bonus=no
                    carryover_report=no
                    carryover_percentage=0
                    music=silence.ogg
                [/endlevel]
            [/event]
        [/event]
    [/event]

    # These handle the graphics for the gate, stolen almost straight from the Scepter of Fire. To be honest, I only understand the bare minimum of this necessary to modify it how I needed to.
    # Normally, the gate is drawn in the "up" position, and after the impassable overlay ^Xo has been removed, an animated version will be drawn, displaying the gate opening.
    [terrain_graphics]
        x,y=102,42
        map="
*,  *,  *
, *,  *,  *
*,  *,  *
, 1,  *,  *
*,  2,  *
, *,  3,  *
*,  *,  *
, *,  *,  *"
        [tile]
            pos=1
            x,y=1,1
            type=*^Xo
        [/tile]
        [tile]
            pos=2
            x,y=2,2
            type=*^Xo
        [/tile]
        [tile]
            pos=3
            x,y=3,2
            type=*^Xo
        [/tile]
        [image]
            name=gate-left-up.png
            base=90,144
        [/image]
        [image]
            name=gate-middle-up.png
            base=144,180
        [/image]
        [image]
            name=gate-right-up.png
            base=196,216
        [/image]
    [/terrain_graphics]
    [terrain_graphics]
        x,y=102,42
        map="
*,  *,  *
, *,  *,  *
*,  *,  *
, 1,  *,  *
*,  2,  *
, *,  3,  *
*,  *,  *
, *,  *,  *"
        [tile]
            pos=1
            x,y=1,1
            type=!,*^Xo
        [/tile]
        [tile]
            pos=2
            x,y=2,2
            type=!,*^Xo
        [/tile]
        [tile]
            pos=3
            x,y=3,2
            type=!,*^Xo
        [/tile]
        # Technically, these animations loop, but only about once per 15 minutes so the user should see the loop very rarely.
        [image]
            name=gate-left-rising-3.png:500,gate-left-rising-2.png:500,gate-left-rising-1.png:500,gate-left-down.png:50000,gate-left-down.png:50000,gate-left-down.png:50000,gate-left-down.png:50000
            base=90,144
        [/image]
        [image]
            name=gate-middle-rising-3.png:500,gate-middle-rising-2.png:500,gate-middle-rising-1.png:500,gate-middle-down.png:50000,gate-middle-down.png:50000,gate-middle-down.png:50000,gate-middle-down.png:50000
            base=144,180
        [/image]
        [image]
            name=gate-right-rising-3.png:500,gate-right-rising-2.png:500,gate-right-rising-1.png:500,gate-right-down.png:50000,gate-right-down.png:50000,gate-right-down.png:50000,gate-right-down.png:50000
            base=196,216
        [/image]
    [/terrain_graphics]

    [event]
        name=victory
        {UNPACK_ALL_UNITS}
        {CLEAR_VARIABLE wind_happened,orbs,in_second_thal,hint_turn}
    [/event]

    {~add-ons/The_Rising_Underworld/utils/deaths.cfg}
[/scenario]
